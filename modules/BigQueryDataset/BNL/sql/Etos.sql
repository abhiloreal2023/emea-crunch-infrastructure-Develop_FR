insert into `emea-crunch-gbl-emea-{env}.d_crunch_bnl_dom_{env}.t_multidivision_etos_b-o`(EAN_UPC_CODE,POS_OR_WEBSITE_CODE,INSERT_DATETIME,UPDATE_DATETIME,CUSTOMER_FREE_COLUMN_1,RUN_ID,SOLD_AMOUNT_IN_LOCAL_CURRENCY,SOLD_QUANTITY_IN_UNITS,US_SIZE,EU_SIZE,EAN_UPC_LABEL,RETAILER_PRODUCT_CODE,YearWeek)


with Header_Data AS(
SELECT * FROM `emea-crunch-gbl-emea-{env}.d_crunch_bnl_stg_{env}.t_multidivision_etos_b-o`
UNPIVOT ((POS_VALUE) for POS_OR_WEBSITE_CODE in (POS_6010, POS_6014, POS_6015, POS_6016, POS_6017, POS_6020, POS_6026, POS_6027, POS_6029, POS_6032, POS_6033, POS_6035, POS_6038, POS_6040, POS_6041, POS_6052, POS_6055, POS_6057, POS_6063, POS_6075, POS_6076, POS_6081, POS_6084, POS_6086, POS_6089, POS_6097, POS_6098, POS_6101, POS_6103, POS_6104, POS_6105, POS_6107, POS_6110, POS_6113, POS_6114, POS_6115, POS_6116, POS_6117, POS_6124, POS_6129, POS_6131, POS_6139, POS_6142, POS_6145, POS_6146, POS_6147, POS_6148, POS_6150, POS_6151, POS_6154, POS_6155, POS_6156, POS_6158, POS_6159, POS_6160, POS_6161, POS_6162, POS_6165, POS_6166, POS_6168, POS_6169, POS_6173, POS_6174, POS_6175, POS_6177, POS_6179, POS_6181, POS_6182, POS_6184, POS_6186, POS_6187, POS_6193, POS_6194, POS_6196, POS_6200, POS_6202, POS_6204, POS_6206, POS_6207, POS_6208, POS_6209, POS_6210, POS_6215, POS_6216, POS_6217, POS_6218, POS_6219, POS_6220, POS_6225, POS_6226, POS_6228, POS_6231, POS_6232, POS_6235, POS_6237, POS_6238, POS_6240, POS_6241, POS_6244, POS_6245, POS_6248, POS_6249, POS_6251, POS_6252, POS_6253, POS_6255, POS_6256, POS_6258, POS_6259, POS_6262, POS_6263, POS_6264, POS_6265, POS_6266, POS_6270, POS_6271, POS_6272, POS_6274, POS_6275, POS_6276, POS_6277, POS_6278, POS_6279, POS_6280, POS_6281, POS_6282, POS_6283, POS_6284, POS_6285, POS_6286, POS_6287, POS_6288, POS_6289, POS_6290, POS_6291, POS_6294, POS_6295, POS_6296, POS_6297, POS_6298, POS_6299, POS_6301, POS_6302, POS_6304, POS_6305, POS_6306, POS_6307, POS_6308, POS_6309, POS_6310, POS_6311, POS_6312, POS_6313, POS_6314, POS_6315, POS_6316, POS_6317, POS_6318, POS_6319, POS_6320, POS_6321, POS_6322, POS_6323, POS_6324, POS_6326, POS_6327, POS_6328, POS_6329, POS_6330, POS_6331, POS_6332, POS_6333, POS_6334, POS_6335, POS_6336, POS_6337, POS_6338, POS_6339, POS_6340, POS_6341, POS_6342, POS_6343, POS_6344, POS_6345, POS_6346, POS_6347, POS_6348, POS_6349, POS_6350, POS_6351, POS_6352, POS_6354, POS_6355, POS_6357, POS_6361, POS_6362, POS_7202, POS_7205, POS_7208, POS_7213, POS_7222, POS_7223, POS_7224, POS_7227, POS_7235, POS_7237, POS_7238, POS_7242, POS_7243, POS_7245, POS_7247, POS_7249, POS_7250, POS_7252, POS_7253, POS_7258, POS_7259, POS_7260, POS_7264, POS_7265, POS_7266, POS_7267, POS_7269, POS_7270, POS_7275, POS_7277, POS_7280, POS_7281, POS_7285, POS_7287, POS_7289, POS_7303, POS_7306, POS_7309, POS_7310, POS_7311, POS_7312, POS_7315, POS_7320, POS_7322, POS_7323, POS_7326, POS_7328, POS_7331, POS_7334, POS_7335, POS_7336, POS_7339, POS_7340, POS_7342, POS_7343, POS_7344, POS_7345, POS_7346, POS_7348, POS_7351, POS_7354, POS_7355, POS_7356, POS_7357, POS_7358, POS_7360, POS_7361, POS_7362, POS_7363, POS_7364, POS_7368, POS_7369, POS_7370, POS_7371, POS_7374, POS_7376, POS_7377, POS_7381, POS_7382, POS_7384, POS_7386, POS_7388, POS_7390, POS_7391, POS_7394, POS_7395, POS_7397, POS_7398, POS_7431, POS_7432, POS_7433, POS_7434, POS_7435, POS_7437, POS_7438, POS_7440, POS_7441, POS_7442, POS_7447, POS_7449, POS_7456, POS_7464, POS_7466, POS_7469, POS_7470, POS_7475, POS_7476, POS_7477, POS_7482, POS_7484, POS_7485, POS_7488, POS_7489, POS_7490, POS_7493, POS_7494, POS_7496, POS_7498, POS_7570, POS_7571, POS_7572, POS_7573, POS_7574, POS_7576, POS_7578, POS_7579, POS_7580, POS_7582, POS_7584, POS_7586, POS_7588, POS_7589, POS_7590, POS_7593, POS_7594, POS_7596, POS_7701, POS_7702, POS_7704, POS_7705, POS_7706, POS_7707, POS_7709, POS_7716, POS_7717, POS_7718, POS_7721, POS_7722, POS_7723, POS_7724, POS_7728, POS_7729, POS_7732, POS_7734, POS_7735, POS_7736, POS_7739, POS_7740, POS_7742, POS_7743, POS_7745, POS_7761, POS_7762, POS_7763, POS_7764, POS_7765, POS_7766, POS_7767, POS_7768, POS_7771, POS_7774, POS_7775, POS_7776, POS_7779, POS_7780, POS_7781, POS_7782, POS_7784, POS_7786, POS_7787, POS_7788, POS_7789, POS_7790, POS_7791, POS_7792, POS_7794, POS_7796, POS_7797, POS_7798, POS_7801, POS_7804, POS_7805, POS_7808, POS_7809, POS_7810, POS_7813, POS_7814, POS_7815, POS_7816, POS_7817, POS_7818, POS_7819, POS_7820, POS_7821, POS_7822, POS_7823, POS_7824, POS_7825, POS_7826, POS_7828, POS_7829, POS_7831, POS_7833, POS_7835, POS_7837, POS_7838, POS_7900, POS_7901, POS_7902, POS_7903, POS_7904, POS_7905, POS_7910, POS_7913, POS_7914, POS_7917, POS_7918, POS_7919, POS_7920, POS_7921, POS_7924, POS_7926, POS_7927, POS_7928, POS_7930, POS_7933, POS_7936, POS_7937, POS_7938, POS_7939, POS_7941, POS_7942, POS_7948, POS_7949, POS_7950, POS_7951, POS_7952, POS_7953, POS_7955, POS_7956, POS_7957, POS_7960, POS_7961, POS_7962, POS_7964, POS_7965, POS_7967, POS_7969, POS_7970, POS_7975, POS_7977, POS_7978, POS_7985, POS_7986, POS_7988, POS_7989, POS_7990, POS_7991, POS_7992, POS_7993, POS_7994, POS_7995, POS_7996, POS_7998, POS_8322, POS_8324, POS_8331, POS_8332, POS_8333, POS_8334, POS_8335, POS_8344, POS_8346, POS_8352, POS_8354, POS_8361, POS_8366, POS_8372, POS_8373, POS_8376, POS_8378, POS_8384, POS_8387, POS_8397, POS_8411, POS_8420, POS_8424, POS_8425, POS_8427, POS_8431, POS_8432, POS_8436, POS_8440, POS_8442, POS_8443, POS_8447, POS_8448, POS_8452, POS_8457, POS_8466, POS_8468, POS_8482, POS_8491, POS_8496, POS_8499, POS_8860, POS_8862, POS_8864, POS_8877, POS_8878, POS_8879, POS_8888, POS_8893, POS_8897, POS_8898
   ))
where EAN_ID = 'EAN ID' and RUN_ID = '{run_id}'),

Retailer_Data AS(
Select * from `emea-crunch-gbl-emea-{env}.d_crunch_bnl_stg_{env}.t_multidivision_etos_b-o`

  where EAN_ID <> 'EAN ID' and RUN_ID = '{run_id}'

)

Select a.EAN_ID as EAN_UPC_CODE, 
b.POS_VALUE As POS_OR_WEBSITE_CODE, 
current_datetime() as INSERT_DATETIME , current_datetime() as UPDATE_DATETIME,
case when a.Brand in ("La Roche-Posay", "Vichy", "CeraVé") then 'ACD'else 'CPD' end as CUSTOMER_FREE_COLUMN_1,
a.RUN_ID,
case when a.Sheet_name = "€ Sales" then a.POS_VALUE else '0' end as SOLD_AMOUNT_IN_LOCAL_CURRENCY,
case when a.Sheet_name = "# Units" then a.POS_VALUE else '0' end as SOLD_QUANTITY_IN_UNITS, 
a.Packaging_Size as US_SIZE,
a.Packaging_Size as EU_SIZE,
a.Item_Description as EAN_UPC_LABEL,
a.Item_ID as RETAILER_PRODUCT_CODE,
a.YearWeek as YearWeek


from 
(
Select * from Retailer_Data a

  UNPIVOT ((POS_VALUE) for POS_OR_WEBSITE_CODE in (POS_6010, POS_6014, POS_6015, POS_6016, POS_6017, POS_6020, POS_6026, POS_6027, POS_6029, POS_6032, POS_6033, POS_6035, POS_6038, POS_6040, POS_6041, POS_6052, POS_6055, POS_6057, POS_6063, POS_6075, POS_6076, POS_6081, POS_6084, POS_6086, POS_6089, POS_6097, POS_6098, POS_6101, POS_6103, POS_6104, POS_6105, POS_6107, POS_6110, POS_6113, POS_6114, POS_6115, POS_6116, POS_6117, POS_6124, POS_6129, POS_6131, POS_6139, POS_6142, POS_6145, POS_6146, POS_6147, POS_6148, POS_6150, POS_6151, POS_6154, POS_6155, POS_6156, POS_6158, POS_6159, POS_6160, POS_6161, POS_6162, POS_6165, POS_6166, POS_6168, POS_6169, POS_6173, POS_6174, POS_6175, POS_6177, POS_6179, POS_6181, POS_6182, POS_6184, POS_6186, POS_6187, POS_6193, POS_6194, POS_6196, POS_6200, POS_6202, POS_6204, POS_6206, POS_6207, POS_6208, POS_6209, POS_6210, POS_6215, POS_6216, POS_6217, POS_6218, POS_6219, POS_6220, POS_6225, POS_6226, POS_6228, POS_6231, POS_6232, POS_6235, POS_6237, POS_6238, POS_6240, POS_6241, POS_6244, POS_6245, POS_6248, POS_6249, POS_6251, POS_6252, POS_6253, POS_6255, POS_6256, POS_6258, POS_6259, POS_6262, POS_6263, POS_6264, POS_6265, POS_6266, POS_6270, POS_6271, POS_6272, POS_6274, POS_6275, POS_6276, POS_6277, POS_6278, POS_6279, POS_6280, POS_6281, POS_6282, POS_6283, POS_6284, POS_6285, POS_6286, POS_6287, POS_6288, POS_6289, POS_6290, POS_6291, POS_6294, POS_6295, POS_6296, POS_6297, POS_6298, POS_6299, POS_6301, POS_6302, POS_6304, POS_6305, POS_6306, POS_6307, POS_6308, POS_6309, POS_6310, POS_6311, POS_6312, POS_6313, POS_6314, POS_6315, POS_6316, POS_6317, POS_6318, POS_6319, POS_6320, POS_6321, POS_6322, POS_6323, POS_6324, POS_6326, POS_6327, POS_6328, POS_6329, POS_6330, POS_6331, POS_6332, POS_6333, POS_6334, POS_6335, POS_6336, POS_6337, POS_6338, POS_6339, POS_6340, POS_6341, POS_6342, POS_6343, POS_6344, POS_6345, POS_6346, POS_6347, POS_6348, POS_6349, POS_6350, POS_6351, POS_6352, POS_6354, POS_6355, POS_6357, POS_6361, POS_6362, POS_7202, POS_7205, POS_7208, POS_7213, POS_7222, POS_7223, POS_7224, POS_7227, POS_7235, POS_7237, POS_7238, POS_7242, POS_7243, POS_7245, POS_7247, POS_7249, POS_7250, POS_7252, POS_7253, POS_7258, POS_7259, POS_7260, POS_7264, POS_7265, POS_7266, POS_7267, POS_7269, POS_7270, POS_7275, POS_7277, POS_7280, POS_7281, POS_7285, POS_7287, POS_7289, POS_7303, POS_7306, POS_7309, POS_7310, POS_7311, POS_7312, POS_7315, POS_7320, POS_7322, POS_7323, POS_7326, POS_7328, POS_7331, POS_7334, POS_7335, POS_7336, POS_7339, POS_7340, POS_7342, POS_7343, POS_7344, POS_7345, POS_7346, POS_7348, POS_7351, POS_7354, POS_7355, POS_7356, POS_7357, POS_7358, POS_7360, POS_7361, POS_7362, POS_7363, POS_7364, POS_7368, POS_7369, POS_7370, POS_7371, POS_7374, POS_7376, POS_7377, POS_7381, POS_7382, POS_7384, POS_7386, POS_7388, POS_7390, POS_7391, POS_7394, POS_7395, POS_7397, POS_7398, POS_7431, POS_7432, POS_7433, POS_7434, POS_7435, POS_7437, POS_7438, POS_7440, POS_7441, POS_7442, POS_7447, POS_7449, POS_7456, POS_7464, POS_7466, POS_7469, POS_7470, POS_7475, POS_7476, POS_7477, POS_7482, POS_7484, POS_7485, POS_7488, POS_7489, POS_7490, POS_7493, POS_7494, POS_7496, POS_7498, POS_7570, POS_7571, POS_7572, POS_7573, POS_7574, POS_7576, POS_7578, POS_7579, POS_7580, POS_7582, POS_7584, POS_7586, POS_7588, POS_7589, POS_7590, POS_7593, POS_7594, POS_7596, POS_7701, POS_7702, POS_7704, POS_7705, POS_7706, POS_7707, POS_7709, POS_7716, POS_7717, POS_7718, POS_7721, POS_7722, POS_7723, POS_7724, POS_7728, POS_7729, POS_7732, POS_7734, POS_7735, POS_7736, POS_7739, POS_7740, POS_7742, POS_7743, POS_7745, POS_7761, POS_7762, POS_7763, POS_7764, POS_7765, POS_7766, POS_7767, POS_7768, POS_7771, POS_7774, POS_7775, POS_7776, POS_7779, POS_7780, POS_7781, POS_7782, POS_7784, POS_7786, POS_7787, POS_7788, POS_7789, POS_7790, POS_7791, POS_7792, POS_7794, POS_7796, POS_7797, POS_7798, POS_7801, POS_7804, POS_7805, POS_7808, POS_7809, POS_7810, POS_7813, POS_7814, POS_7815, POS_7816, POS_7817, POS_7818, POS_7819, POS_7820, POS_7821, POS_7822, POS_7823, POS_7824, POS_7825, POS_7826, POS_7828, POS_7829, POS_7831, POS_7833, POS_7835, POS_7837, POS_7838, POS_7900, POS_7901, POS_7902, POS_7903, POS_7904, POS_7905, POS_7910, POS_7913, POS_7914, POS_7917, POS_7918, POS_7919, POS_7920, POS_7921, POS_7924, POS_7926, POS_7927, POS_7928, POS_7930, POS_7933, POS_7936, POS_7937, POS_7938, POS_7939, POS_7941, POS_7942, POS_7948, POS_7949, POS_7950, POS_7951, POS_7952, POS_7953, POS_7955, POS_7956, POS_7957, POS_7960, POS_7961, POS_7962, POS_7964, POS_7965, POS_7967, POS_7969, POS_7970, POS_7975, POS_7977, POS_7978, POS_7985, POS_7986, POS_7988, POS_7989, POS_7990, POS_7991, POS_7992, POS_7993, POS_7994, POS_7995, POS_7996, POS_7998, POS_8322, POS_8324, POS_8331, POS_8332, POS_8333, POS_8334, POS_8335, POS_8344, POS_8346, POS_8352, POS_8354, POS_8361, POS_8366, POS_8372, POS_8373, POS_8376, POS_8378, POS_8384, POS_8387, POS_8397, POS_8411, POS_8420, POS_8424, POS_8425, POS_8427, POS_8431, POS_8432, POS_8436, POS_8440, POS_8442, POS_8443, POS_8447, POS_8448, POS_8452, POS_8457, POS_8466, POS_8468, POS_8482, POS_8491, POS_8496, POS_8499, POS_8860, POS_8862, POS_8864, POS_8877, POS_8878, POS_8879, POS_8888, POS_8893, POS_8897, POS_8898
   ))
  ) A

LEFT JOIN Header_Data B

ON A.POS_OR_WEBSITE_CODE = B.POS_OR_WEBSITE_CODE
where a.RUN_ID = '{run_id}'


